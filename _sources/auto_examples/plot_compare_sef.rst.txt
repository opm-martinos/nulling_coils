
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_compare_sef.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_plot_compare_sef.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_compare_sef.py:


=============================
06. Analyze SEF Data with OPM
=============================

This example demonstrates how to analyze somatosensory evoked field (SEF) data
collected with optically pumped magnetometers (OPM) and compare it with
superconducting quantum interference device (SQUID) data. The OPM data was
obtained with the background field nulling coils we developed.

.. GENERATED FROM PYTHON SOURCE LINES 11-25

.. code-block:: default


    # Author: Mainak Jas <mjas@mgh.harvard.edu>

    import json
    import matplotlib.pyplot as plt

    import mne
    from opmcoils.analysis import find_events, add_ch_loc, read_opm_info

    from pathlib import Path
    import pooch

    # sphinx_gallery_thumbnail_number = 3








.. GENERATED FROM PYTHON SOURCE LINES 26-27

First, use pooch to download the data

.. GENERATED FROM PYTHON SOURCE LINES 27-42

.. code-block:: default


    url = "https://osf.io/aqh27/download"

    target_dir = Path.cwd() / 'data'
    project_dir = target_dir / 'sef_data'

    path = pooch.retrieve(
        url=url,
        known_hash=None,  # We don't know the hash
        path=target_dir,
        fname='sub-01.zip',  # Specify the filename
        processor=pooch.Unzip(extract_dir=project_dir),  # Extract to a folder named 'sub-01'
        progressbar=True
    )








.. GENERATED FROM PYTHON SOURCE LINES 43-44

Then, we define the file paths

.. GENERATED FROM PYTHON SOURCE LINES 44-55

.. code-block:: default


    subject = 'sub-01'
    date = '20240722'
    cond = 'median'

    subjects_dir = project_dir / subject
    raw_fname = subjects_dir / 'opm_meg' / date / f'{date}_{subject}_paneltesting_{cond}_raw.fif'
    raw_fname_squid = subjects_dir / 'squid_meg' / date / 'RT_median_raw.fif'
    helmet_info_fname = target_dir / 'helmet_99channel_size-60.fif'
    ch_mapping_fname = subjects_dir / 'opm_meg' / date / 'mapping.json'








.. GENERATED FROM PYTHON SOURCE LINES 56-57

Then, we start by processing OPM data

.. GENERATED FROM PYTHON SOURCE LINES 57-65

.. code-block:: default

    bads = ['01:15', '00:14', '00:15', '00:16']

    raw_opm = mne.io.read_raw_fif(raw_fname, preload=True)
    raw_opm.rename_channels(lambda x: x.strip('-BZ_CL'))
    raw_opm.info['bads'] = bads

    raw_opm.set_channel_types({'Input-1': 'stim'})





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Opening raw data file /Users/mainak/Desktop/github_repos/cmeg_coil_design/examples/data/sef_data/sub-01/opm_meg/20240722/20240722_sub-01_paneltesting_median_raw.fif...
    Isotrak not found
        Range : 0 ... 303721 =      0.000 ...   303.721 secs
    Ready.
    Reading 0 ... 303721  =      0.000 ...   303.721 secs...


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <script type="text/javascript">
        const toggleVisibility = (className) => {

      const elements = document.querySelectorAll(`.${className}`)

      elements.forEach(element => {
        if (element.classList.contains('repr-section-header')) {
          // Don't collapse the section header row.
           return
        }
        if (element.classList.contains('repr-element-collapsed')) {
          // Force a reflow to ensure the display change takes effect before removing the class
          element.classList.remove('repr-element-collapsed')
          element.offsetHeight // This forces the browser to recalculate layout
          element.classList.remove('repr-element-faded')
        } else {
          // Start transition to hide the element
          element.classList.add('repr-element-faded')
          element.addEventListener('transitionend', handler = (e) => {
            if (e.propertyName === 'opacity' && getComputedStyle(element).opacity === '0.2') {
              element.classList.add('repr-element-collapsed')
              element.removeEventListener('transitionend', handler)
            }
          });
        }
      });

      // Take care of button (adjust caret)
      const button = document.querySelectorAll(`.repr-section-header.${className} > th.repr-section-toggle-col > button`)[0]
      button.classList.toggle('collapsed')

      // Take care of the tooltip of the section header row
      const sectionHeaderRow = document.querySelectorAll(`tr.repr-section-header.${className}`)[0]
      sectionHeaderRow.classList.toggle('collapsed')
      sectionHeaderRow.title = sectionHeaderRow.title === 'Hide section' ? 'Show section' : 'Hide section'
    }
    </script>

    <style type="text/css">
        table.repr.table.table-hover.table-striped.table-sm.table-responsive.small {
      /* Don't make rows wider than they need to be. */
      display: inline;
    }

    table > tbody > tr.repr-element > td {
      /* Apply a tighter layout to the table cells. */
      padding-top: 0.1rem;
      padding-bottom: 0.1rem;
      padding-right: 1rem;
    }

    table > tbody > tr > td.repr-section-toggle-col {
      /* Remove background and border of the first cell in every row
         (this row is only used for the collapse / uncollapse caret)

         TODO: Need to find a good solution for VS Code that works in both
               light and dark mode. */
      border-color: transparent;
      --bs-table-accent-bg: transparent;
    }

    tr.repr-section-header {
      /* Remove stripes from section header rows */
      background-color: transparent;
      border-color: transparent;
      --bs-table-striped-bg: transparent;
      cursor: pointer;
    }

    tr.repr-section-header > th {
      text-align: left !important;
      vertical-align: middle;
    }

    .repr-element, tr.repr-element > td {
      opacity: 1;
      text-align: left !important;
    }

    .repr-element-faded {
      transition: 0.3s ease;
      opacity: 0.2;
    }

    .repr-element-collapsed {
      display: none;
    }

    /* Collapse / uncollapse button and the caret it contains. */
    .repr-section-toggle-col button {
      cursor: pointer;
      width: 1rem;
      background-color: transparent;
      border-color: transparent;
    }

    span.collapse-uncollapse-caret {
      width: 1rem;
      height: 1rem;
      display: block;
      background-repeat: no-repeat;
      background-position: left;
      background-size: contain;
    }

    /* The collapse / uncollapse carets were copied from the free Font Awesome collection and adjusted. */

    /* Default to black carets for light mode */
    .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
    }

    .repr-section-toggle-col
      > button:not(.collapsed)
      > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
    }

    /* Use white carets for dark mode */
    @media (prefers-color-scheme: dark) {
      .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
      }

      .repr-section-toggle-col
        > button:not(.collapsed)
        > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
      }
    }

    .channel-names-btn {
      padding: 0;
      border: none;
      background: none;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      color: #0d6efd;
    }

    .channel-names-btn:hover {
      color: #0a58ca;
    }
    </style>



    <table class="repr table table-hover table-striped table-sm table-responsive small">
    







    <tr class="repr-section-header general-15d92238-ecd5-4666-880b-379dc11273f7"  title="Hide section" 
        onclick="toggleVisibility('general-15d92238-ecd5-4666-880b-379dc11273f7')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>General</strong>
        </th>
    </tr>

    <tr class="repr-element general-15d92238-ecd5-4666-880b-379dc11273f7 ">
        <td class="repr-section-toggle-col"></td>
        <td>Filename(s)</td>
        <td>
        
            20240722_sub-01_paneltesting_median_raw.fif
        
        
        </td>
    </tr>

    <tr class="repr-element general-15d92238-ecd5-4666-880b-379dc11273f7 ">
        <td class="repr-section-toggle-col"></td>
        <td>MNE object type</td>
        <td>Raw</td>
    </tr>
    <tr class="repr-element general-15d92238-ecd5-4666-880b-379dc11273f7 ">
        <td class="repr-section-toggle-col"></td>
        <td>Measurement date</td>
    
        <td>2024-07-22 at 18:06:45 UTC</td>
    
    </tr>
    <tr class="repr-element general-15d92238-ecd5-4666-880b-379dc11273f7 ">
        <td class="repr-section-toggle-col"></td>
        <td>Participant</td>
    
        <td>Unknown</td>
    
    </tr>
    <tr class="repr-element general-15d92238-ecd5-4666-880b-379dc11273f7 ">
        <td class="repr-section-toggle-col"></td>
        <td>Experimenter</td>
    
        <td>Unknown</td>
    
    </tr>
    







    <tr class="repr-section-header acquisition-ac2630a4-1565-4e58-b2fe-b34333134fa0" 
        title="Hide section"  onclick="toggleVisibility('acquisition-ac2630a4-1565-4e58-b2fe-b34333134fa0')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Acquisition</strong>
        </th>
    </tr>

    <tr class="repr-element acquisition-ac2630a4-1565-4e58-b2fe-b34333134fa0 ">
        <td class="repr-section-toggle-col"></td>
        <td>Duration</td>
        <td>00:05:04 (HH:MM:SS)</td>
    </tr>








    <tr class="repr-element acquisition-ac2630a4-1565-4e58-b2fe-b34333134fa0 ">
        <td class="repr-section-toggle-col"></td>
        <td>Sampling frequency</td>
        <td>1000.00 Hz</td>
    </tr>


    <tr class="repr-element acquisition-ac2630a4-1565-4e58-b2fe-b34333134fa0 ">
        <td class="repr-section-toggle-col"></td>
        <td>Time points</td>
        <td>303,722</td>
    </tr>


    







    <tr class="repr-section-header channels-cc4955d4-0012-4ddb-a962-f2a609b4cd06"  title="Hide section" 
        onclick="toggleVisibility('channels-cc4955d4-0012-4ddb-a962-f2a609b4cd06')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Channels</strong>
        </th>
    </tr>


    <tr class="repr-element channels-cc4955d4-0012-4ddb-a962-f2a609b4cd06 ">
        <td class="repr-section-toggle-col"></td>
        <td>Magnetometers</td>
        <td>
            <button class="channel-names-btn" onclick="alert('Good Magnetometers:\n\n00:01, 00:03, 00:04, 00:08, 00:11, 01:01, 01:03, 01:04, 01:06, 01:08, 01:09, 01:10, 01:13, 01:14, 01:16')" title="(Click to open in popup)&#13;&#13;00:01, 00:03, 00:04, 00:08, 00:11, 01:01, 01:03, 01:04, 01:06, 01:08, 01:09, 01:10, 01:13, 01:14, 01:16">
                15
            </button>

        
        
            and <button class="channel-names-btn" onclick="alert('Bad Magnetometers:\n\n00:14, 00:15, 00:16, 01:15')" title="(Click to open in popup)&#13;&#13;00:14, 00:15, 00:16, 01:15">
                4 bad
            </button>
        
        </td>
    </tr>


    <tr class="repr-element channels-cc4955d4-0012-4ddb-a962-f2a609b4cd06 ">
        <td class="repr-section-toggle-col"></td>
        <td>Stimulus</td>
        <td>
            <button class="channel-names-btn" onclick="alert('Good Stimulus:\n\nInput-1')" title="(Click to open in popup)&#13;&#13;Input-1">
                1
            </button>

        
        </td>
    </tr>


    <tr class="repr-element channels-cc4955d4-0012-4ddb-a962-f2a609b4cd06 ">
        <td class="repr-section-toggle-col"></td>
        <td>Head & sensor digitization</td>
    
        <td>Not available</td>
    
    </tr>
    







    <tr class="repr-section-header filters-aa2954c6-dbe6-4521-85bf-cb2e8f9803dd"  title="Hide section" 
        onclick="toggleVisibility('filters-aa2954c6-dbe6-4521-85bf-cb2e8f9803dd')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Filters</strong>
        </th>
    </tr>

    <tr class="repr-element filters-aa2954c6-dbe6-4521-85bf-cb2e8f9803dd ">
        <td class="repr-section-toggle-col"></td>
        <td>Highpass</td>
        <td>0.00 Hz</td>
    </tr>


    <tr class="repr-element filters-aa2954c6-dbe6-4521-85bf-cb2e8f9803dd ">
        <td class="repr-section-toggle-col"></td>
        <td>Lowpass</td>
        <td>500.00 Hz</td>
    </tr>


    </table>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 66-68

Electrical median nerve stimulation creates artifacts. We
will annotate the artifacts to avoid filtering the sharp transients.

.. GENERATED FROM PYTHON SOURCE LINES 68-81

.. code-block:: default

    events = find_events(raw_opm, min_duration=1. / raw_opm.info['sfreq'])
    annot = mne.annotations_from_events(events, raw_opm.info['sfreq'],
                                        event_desc={1: 'BAD_STIM'})
    # XXX: annotations_from_events should have duration option
    annot.onset -= 0.002
    annot.duration += 0.003

    raw_opm.notch_filter(60.)

    raw_opm.set_annotations(annot)
    raw_opm.filter(4., None, skip_by_annotation=())
    raw_opm.filter(None, 150, skip_by_annotation=('BAD_STIM'))





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    608 events found on stim channel Input-1
    Event IDs: [1]
    Filtering raw data in 1 contiguous segment
    Setting up band-stop filter from 59 - 61 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal bandstop filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Lower passband edge: 59.35
    - Lower transition bandwidth: 0.50 Hz (-6 dB cutoff frequency: 59.10 Hz)
    - Upper passband edge: 60.65 Hz
    - Upper transition bandwidth: 0.50 Hz (-6 dB cutoff frequency: 60.90 Hz)
    - Filter length: 6601 samples (6.601 s)

    Filtering raw data in 1 contiguous segment
    Setting up high-pass filter at 4 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal highpass filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Lower passband edge: 4.00
    - Lower transition bandwidth: 2.00 Hz (-6 dB cutoff frequency: 3.00 Hz)
    - Filter length: 1651 samples (1.651 s)

    Filtering raw data in 609 contiguous segments
    Setting up low-pass filter at 1.5e+02 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal lowpass filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Upper passband edge: 150.00 Hz
    - Upper transition bandwidth: 37.50 Hz (-6 dB cutoff frequency: 168.75 Hz)
    - Filter length: 89 samples (0.089 s)



.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <script type="text/javascript">
        const toggleVisibility = (className) => {

      const elements = document.querySelectorAll(`.${className}`)

      elements.forEach(element => {
        if (element.classList.contains('repr-section-header')) {
          // Don't collapse the section header row.
           return
        }
        if (element.classList.contains('repr-element-collapsed')) {
          // Force a reflow to ensure the display change takes effect before removing the class
          element.classList.remove('repr-element-collapsed')
          element.offsetHeight // This forces the browser to recalculate layout
          element.classList.remove('repr-element-faded')
        } else {
          // Start transition to hide the element
          element.classList.add('repr-element-faded')
          element.addEventListener('transitionend', handler = (e) => {
            if (e.propertyName === 'opacity' && getComputedStyle(element).opacity === '0.2') {
              element.classList.add('repr-element-collapsed')
              element.removeEventListener('transitionend', handler)
            }
          });
        }
      });

      // Take care of button (adjust caret)
      const button = document.querySelectorAll(`.repr-section-header.${className} > th.repr-section-toggle-col > button`)[0]
      button.classList.toggle('collapsed')

      // Take care of the tooltip of the section header row
      const sectionHeaderRow = document.querySelectorAll(`tr.repr-section-header.${className}`)[0]
      sectionHeaderRow.classList.toggle('collapsed')
      sectionHeaderRow.title = sectionHeaderRow.title === 'Hide section' ? 'Show section' : 'Hide section'
    }
    </script>

    <style type="text/css">
        table.repr.table.table-hover.table-striped.table-sm.table-responsive.small {
      /* Don't make rows wider than they need to be. */
      display: inline;
    }

    table > tbody > tr.repr-element > td {
      /* Apply a tighter layout to the table cells. */
      padding-top: 0.1rem;
      padding-bottom: 0.1rem;
      padding-right: 1rem;
    }

    table > tbody > tr > td.repr-section-toggle-col {
      /* Remove background and border of the first cell in every row
         (this row is only used for the collapse / uncollapse caret)

         TODO: Need to find a good solution for VS Code that works in both
               light and dark mode. */
      border-color: transparent;
      --bs-table-accent-bg: transparent;
    }

    tr.repr-section-header {
      /* Remove stripes from section header rows */
      background-color: transparent;
      border-color: transparent;
      --bs-table-striped-bg: transparent;
      cursor: pointer;
    }

    tr.repr-section-header > th {
      text-align: left !important;
      vertical-align: middle;
    }

    .repr-element, tr.repr-element > td {
      opacity: 1;
      text-align: left !important;
    }

    .repr-element-faded {
      transition: 0.3s ease;
      opacity: 0.2;
    }

    .repr-element-collapsed {
      display: none;
    }

    /* Collapse / uncollapse button and the caret it contains. */
    .repr-section-toggle-col button {
      cursor: pointer;
      width: 1rem;
      background-color: transparent;
      border-color: transparent;
    }

    span.collapse-uncollapse-caret {
      width: 1rem;
      height: 1rem;
      display: block;
      background-repeat: no-repeat;
      background-position: left;
      background-size: contain;
    }

    /* The collapse / uncollapse carets were copied from the free Font Awesome collection and adjusted. */

    /* Default to black carets for light mode */
    .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
    }

    .repr-section-toggle-col
      > button:not(.collapsed)
      > span.collapse-uncollapse-caret {
      background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="black" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
    }

    /* Use white carets for dark mode */
    @media (prefers-color-scheme: dark) {
      .repr-section-toggle-col > button.collapsed > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M246.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-128-128c-9.2-9.2-22.9-11.9-34.9-6.9s-19.8 16.6-19.8 29.6l0 256c0 12.9 7.8 24.6 19.8 29.6s25.7 2.2 34.9-6.9l128-128z"/></svg>');
      }

      .repr-section-toggle-col
        > button:not(.collapsed)
        > span.collapse-uncollapse-caret {
        background-image: url('data:image/svg+xml;charset=utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path fill="white" d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z"/></svg>');
      }
    }

    .channel-names-btn {
      padding: 0;
      border: none;
      background: none;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      color: #0d6efd;
    }

    .channel-names-btn:hover {
      color: #0a58ca;
    }
    </style>



    <table class="repr table table-hover table-striped table-sm table-responsive small">
    







    <tr class="repr-section-header general-253d15cf-2eb0-46c1-b522-e3a3bc42a930"  title="Hide section" 
        onclick="toggleVisibility('general-253d15cf-2eb0-46c1-b522-e3a3bc42a930')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>General</strong>
        </th>
    </tr>

    <tr class="repr-element general-253d15cf-2eb0-46c1-b522-e3a3bc42a930 ">
        <td class="repr-section-toggle-col"></td>
        <td>Filename(s)</td>
        <td>
        
            20240722_sub-01_paneltesting_median_raw.fif
        
        
        </td>
    </tr>

    <tr class="repr-element general-253d15cf-2eb0-46c1-b522-e3a3bc42a930 ">
        <td class="repr-section-toggle-col"></td>
        <td>MNE object type</td>
        <td>Raw</td>
    </tr>
    <tr class="repr-element general-253d15cf-2eb0-46c1-b522-e3a3bc42a930 ">
        <td class="repr-section-toggle-col"></td>
        <td>Measurement date</td>
    
        <td>2024-07-22 at 18:06:45 UTC</td>
    
    </tr>
    <tr class="repr-element general-253d15cf-2eb0-46c1-b522-e3a3bc42a930 ">
        <td class="repr-section-toggle-col"></td>
        <td>Participant</td>
    
        <td>Unknown</td>
    
    </tr>
    <tr class="repr-element general-253d15cf-2eb0-46c1-b522-e3a3bc42a930 ">
        <td class="repr-section-toggle-col"></td>
        <td>Experimenter</td>
    
        <td>Unknown</td>
    
    </tr>
    







    <tr class="repr-section-header acquisition-9ffca490-26de-4c90-ab63-e3fc29c56a60" 
        title="Hide section"  onclick="toggleVisibility('acquisition-9ffca490-26de-4c90-ab63-e3fc29c56a60')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Acquisition</strong>
        </th>
    </tr>

    <tr class="repr-element acquisition-9ffca490-26de-4c90-ab63-e3fc29c56a60 ">
        <td class="repr-section-toggle-col"></td>
        <td>Duration</td>
        <td>00:05:04 (HH:MM:SS)</td>
    </tr>








    <tr class="repr-element acquisition-9ffca490-26de-4c90-ab63-e3fc29c56a60 ">
        <td class="repr-section-toggle-col"></td>
        <td>Sampling frequency</td>
        <td>1000.00 Hz</td>
    </tr>


    <tr class="repr-element acquisition-9ffca490-26de-4c90-ab63-e3fc29c56a60 ">
        <td class="repr-section-toggle-col"></td>
        <td>Time points</td>
        <td>303,722</td>
    </tr>


    







    <tr class="repr-section-header channels-00b704ec-6e0b-4418-9879-c5721f47fd14"  title="Hide section" 
        onclick="toggleVisibility('channels-00b704ec-6e0b-4418-9879-c5721f47fd14')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Channels</strong>
        </th>
    </tr>


    <tr class="repr-element channels-00b704ec-6e0b-4418-9879-c5721f47fd14 ">
        <td class="repr-section-toggle-col"></td>
        <td>Magnetometers</td>
        <td>
            <button class="channel-names-btn" onclick="alert('Good Magnetometers:\n\n00:01, 00:03, 00:04, 00:08, 00:11, 01:01, 01:03, 01:04, 01:06, 01:08, 01:09, 01:10, 01:13, 01:14, 01:16')" title="(Click to open in popup)&#13;&#13;00:01, 00:03, 00:04, 00:08, 00:11, 01:01, 01:03, 01:04, 01:06, 01:08, 01:09, 01:10, 01:13, 01:14, 01:16">
                15
            </button>

        
        
            and <button class="channel-names-btn" onclick="alert('Bad Magnetometers:\n\n00:14, 00:15, 00:16, 01:15')" title="(Click to open in popup)&#13;&#13;00:14, 00:15, 00:16, 01:15">
                4 bad
            </button>
        
        </td>
    </tr>


    <tr class="repr-element channels-00b704ec-6e0b-4418-9879-c5721f47fd14 ">
        <td class="repr-section-toggle-col"></td>
        <td>Stimulus</td>
        <td>
            <button class="channel-names-btn" onclick="alert('Good Stimulus:\n\nInput-1')" title="(Click to open in popup)&#13;&#13;Input-1">
                1
            </button>

        
        </td>
    </tr>


    <tr class="repr-element channels-00b704ec-6e0b-4418-9879-c5721f47fd14 ">
        <td class="repr-section-toggle-col"></td>
        <td>Head & sensor digitization</td>
    
        <td>Not available</td>
    
    </tr>
    







    <tr class="repr-section-header filters-cdaeeae6-f1bf-46d5-b130-5468bc02f63c"  title="Hide section" 
        onclick="toggleVisibility('filters-cdaeeae6-f1bf-46d5-b130-5468bc02f63c')">
        <th class="repr-section-toggle-col">
            <button>
            
                <span class="collapse-uncollapse-caret"></span>
            </button>
        </th>
        <th colspan="2">
            <strong>Filters</strong>
        </th>
    </tr>

    <tr class="repr-element filters-cdaeeae6-f1bf-46d5-b130-5468bc02f63c ">
        <td class="repr-section-toggle-col"></td>
        <td>Highpass</td>
        <td>4.00 Hz</td>
    </tr>


    <tr class="repr-element filters-cdaeeae6-f1bf-46d5-b130-5468bc02f63c ">
        <td class="repr-section-toggle-col"></td>
        <td>Lowpass</td>
        <td>150.00 Hz</td>
    </tr>


    </table>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 82-83

Then, we create evoked response

.. GENERATED FROM PYTHON SOURCE LINES 83-90

.. code-block:: default

    reject = None # dict(mag=11e-12)
    epochs_opm = mne.Epochs(raw_opm, events, tmax=0.3,  # ISI = 300 ms
                            reject_by_annotation=False,
                            reject=reject, reject_tmin=0.03,
                            preload=True)
    evoked_opm = epochs_opm.average()





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Not setting metadata
    608 matching events found
    Setting baseline interval to [-0.2, 0.0] s
    Applying baseline correction (mode: mean)
    0 projection items activated
    Using data from preloaded Raw for 608 events and 501 original time points ...
    1 bad epochs dropped




.. GENERATED FROM PYTHON SOURCE LINES 91-93

We add channel locations for the OPM sensors
and plot the evoked response with spatial colors.

.. GENERATED FROM PYTHON SOURCE LINES 93-102

.. code-block:: default

    info_helmet = read_opm_info(helmet_info_fname)

    with open(ch_mapping_fname, 'r') as fd:
        ch_mapping = json.load(fd)

    add_ch_loc(evoked_opm, info_helmet, ch_mapping)

    evoked_opm.plot()




.. image-sg:: /auto_examples/images/sphx_glr_plot_compare_sef_001.png
   :alt: Magnetometers (15 channels)
   :srcset: /auto_examples/images/sphx_glr_plot_compare_sef_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Isotrak not found

    <Figure size 640x300 with 2 Axes>



.. GENERATED FROM PYTHON SOURCE LINES 103-104

Let us now process the SQUID data.

.. GENERATED FROM PYTHON SOURCE LINES 104-123

.. code-block:: default

    raw_squid = mne.io.read_raw_fif(raw_fname_squid, raw_fname_squid, preload=True)
    raw_squid.pick_types(meg='mag', stim=True)
    events = mne.find_events(raw_squid, min_duration=1. / raw_opm.info['sfreq'])

    annot = mne.annotations_from_events(events, raw_squid.info['sfreq'],
                                        event_desc={1: 'BAD_STIM'})
    # XXX: annotations_from_events should have duration option
    annot.onset -= 0.002
    annot.duration += 0.003
    raw_squid.set_annotations(annot)

    raw_squid.filter(4., None)
    raw_squid.notch_filter(60.)
    raw_squid.filter(None, 150, skip_by_annotation=('BAD_STIM'))
    epochs = mne.Epochs(raw_squid, events, tmax=0.3,
                        reject_by_annotation=False)
    evoked_squid = epochs.average()
    evoked_squid.plot(ylim=dict(mag=(-300, 300)))




.. image-sg:: /auto_examples/images/sphx_glr_plot_compare_sef_002.png
   :alt: Magnetometers (102 channels)
   :srcset: /auto_examples/images/sphx_glr_plot_compare_sef_002.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Opening raw data file /Users/mainak/Desktop/github_repos/cmeg_coil_design/examples/data/sef_data/sub-01/squid_meg/20240722/RT_median_raw.fif...
        Read a total of 6 projection items:
            generated with dossp-2.1 (1 x 306)  idle
            generated with dossp-2.1 (1 x 306)  idle
            generated with dossp-2.1 (1 x 306)  idle
            generated with dossp-2.1 (1 x 306)  idle
            generated with dossp-2.1 (1 x 306)  idle
            generated with dossp-2.1 (1 x 306)  idle
        Range : 45000 ... 543999 =     22.500 ...   272.000 secs
    Ready.
    Reading 0 ... 498999  =      0.000 ...   249.500 secs...
    NOTE: pick_types() is a legacy function. New code should use inst.pick(...).
    496 events found on stim channel STI101
    Event IDs: [1]
    /Users/mainak/Desktop/github_repos/cmeg_coil_design/examples/plot_compare_sef.py:113: RuntimeWarning: Omitted 45 annotation(s) that were outside data range.
      raw_squid.set_annotations(annot)
    Filtering raw data in 1 contiguous segment
    Setting up high-pass filter at 4 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal highpass filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Lower passband edge: 4.00
    - Lower transition bandwidth: 2.00 Hz (-6 dB cutoff frequency: 3.00 Hz)
    - Filter length: 3301 samples (1.651 s)

    Filtering raw data in 1 contiguous segment
    Setting up band-stop filter from 59 - 61 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal bandstop filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Lower passband edge: 59.35
    - Lower transition bandwidth: 0.50 Hz (-6 dB cutoff frequency: 59.10 Hz)
    - Upper passband edge: 60.65 Hz
    - Upper transition bandwidth: 0.50 Hz (-6 dB cutoff frequency: 60.90 Hz)
    - Filter length: 13201 samples (6.601 s)

    Filtering raw data in 452 contiguous segments
    Setting up low-pass filter at 1.5e+02 Hz

    FIR filter parameters
    ---------------------
    Designing a one-pass, zero-phase, non-causal lowpass filter:
    - Windowed time-domain design (firwin) method
    - Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation
    - Upper passband edge: 150.00 Hz
    - Upper transition bandwidth: 37.50 Hz (-6 dB cutoff frequency: 168.75 Hz)
    - Filter length: 177 samples (0.088 s)

    Not setting metadata
    496 matching events found
    Setting baseline interval to [-0.2, 0.0] s
    Applying baseline correction (mode: mean)
    Created an SSP operator (subspace dimension = 4)
    6 projection items activated

    <Figure size 640x300 with 2 Axes>



.. GENERATED FROM PYTHON SOURCE LINES 124-130

"Butterfly plots" are not appropriate to compare the
evoked responses between OPMs and SQUID because the sensor
locations are not comparable and hide individual sensor time series.

That is why, we pick sensors in similar locations on the
OPM-MEG and SQUID-MEG and compare the evoked responses.

.. GENERATED FROM PYTHON SOURCE LINES 130-155

.. code-block:: default


    squid_chs = ['MEG0431', 'MEG0311']
    opm_chs = ['MEG30', 'MEG09']
    scale = 1e15
    fig, axes = plt.subplots(2, 1, sharex=True)

    for i, (opm_ch, squid_ch) in enumerate(zip(opm_chs, squid_chs)):
        ax = axes[i].twinx()
        ln1 = axes[i].plot(evoked_opm.times * 1e3,
                           evoked_opm.copy().pick([opm_ch]).data[0] * scale,
                           '#e66101')
        ln2 = ax.plot(evoked_squid.times * 1e3,
                      evoked_squid.copy().pick([squid_ch]).data[0] * scale,
                      '#5e3c99')
        axes[i].set_title(f'Location #{i + 1}')
        axes[i].legend(ln1 + ln2, ['OPM', 'SQUID'], loc=1)
        ax.legend()

    fig.text(0.97, 0.45, 'SQUID data (fT)', va='center',
             rotation='vertical', fontsize=12)
    fig.text(0.02, 0.45, 'OPM data (fT)', va='center',
             rotation='vertical', fontsize=12)
    axes[1].set_xlabel('Time (ms)')
    plt.tight_layout()
    plt.show()



.. image-sg:: /auto_examples/images/sphx_glr_plot_compare_sef_003.png
   :alt: Location #1, Location #2
   :srcset: /auto_examples/images/sphx_glr_plot_compare_sef_003.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
    No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 11.586 seconds)


.. _sphx_glr_download_auto_examples_plot_compare_sef.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_compare_sef.py <plot_compare_sef.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_compare_sef.ipynb <plot_compare_sef.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
